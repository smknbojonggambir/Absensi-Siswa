<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Absensi SMKN Bojonggambir</title>
  <style>
    /* CSS RESPONSIF & MODERN */
    :root { --primary: #2563eb; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--bg); 
      margin: 0; 
      padding: 20px; 
      color: var(--text); 
      display: flex; 
      justify-content: center; 
      min-height: 90vh; 
    }

    .container { width: 100%; max-width: 420px; }
    
    .card { 
      background: var(--card); 
      padding: 24px; 
      border-radius: 16px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    }

    h1 { margin: 0 0 4px; font-size: 20px; text-align: center; }
    
    .subtitle { 
      text-align: center; 
      color: #6b7280; 
      font-size: 13px; 
      margin-bottom: 20px; 
      background: #eef2ff; 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 20px; 
      width: 100%; 
      box-sizing: border-box;
    }

    label { display: block; font-weight: 600; font-size: 14px; margin: 12px 0 6px; }
    
    select, input, textarea { 
      width: 100%; 
      padding: 12px; 
      border: 1px solid #d1d5db; 
      border-radius: 10px; 
      font-size: 16px; 
      background: #fff; 
      box-sizing: border-box; 
    }

    select:focus, input:focus, textarea:focus { 
      border-color: var(--primary); 
      outline: none; 
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
    }

    input[readonly] { background: #f9fafb; color: #6b7280; }

    button { 
      width: 100%; 
      margin-top: 24px; 
      padding: 14px; 
      background: var(--primary); 
      color: white; 
      border: none; 
      border-radius: 10px; 
      font-size: 16px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    button:hover { background-color: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }

    /* Spinner Loading */
    .spinner { 
      display: none; 
      width: 14px; 
      height: 14px; 
      border: 2px solid #ccc; 
      border-top-color: var(--primary); 
      border-radius: 50%; 
      animation: spin 0.8s linear infinite; 
      margin-left: 5px; 
      vertical-align: middle; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Feedback Messages */
    #msg { 
      margin-top: 16px; 
      text-align: center; 
      font-size: 14px; 
      padding: 10px; 
      border-radius: 8px; 
      display: none; 
    }
    .success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    /* Style baru untuk peringatan Terlambat (Kuning/Oranye) */
    .warning { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <h1>Absensi Siswa</h1>
    <div class="subtitle" id="tanggalDisplay">Memuat Tanggal...</div>

    <form onsubmit="return false">
      <label>Kelas <span id="loadKelas" class="spinner"></span></label>
      <select id="kelas" onchange="loadSiswa()">
        <option value="">-- Pilih Kelas --</option>
      </select>

      <label>Nama Siswa <span id="loadSiswa" class="spinner"></span></label>
      <select id="nama" onchange="setNIS()" disabled>
        <option value="">-- Pilih Kelas Dulu --</option>
      </select>

      <label>NIS</label>
      <input type="text" id="nis" placeholder="Otomatis" readonly>

      <label>Status Kehadiran</label>
      <select id="status">
        <option value="Hadir">‚úÖ Hadir</option>
        <option value="Terlambat">‚ö†Ô∏è Terlambat</option>
        <option value="Izin">üì© Izin</option>
        <option value="Sakit">ü§í Sakit</option>
      </select>

      <label>Keterangan (Opsional)</label>
      <textarea id="ket" rows="2" placeholder="Alasan..."></textarea>

      <button id="btnKirim" onclick="kirimData()">Kirim Absensi</button>
    </form>
    <div id="msg"></div>
  </div>
</div>

<script>
  // ==========================================
  // URL SCRIPT GOOGLE APPS SCRIPT
  // ==========================================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwF6p4YykLw3g2aqzQpnlxLO2rshldr_YifkbVTVwWY8QDUet8lHc2J22RBnAJ0sjRl/exec'; 

  let dbSiswa = [];

  // 1. Initial Load (Tanggal & Daftar Kelas)
  window.onload = function() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('tanggalDisplay').innerText = new Date().toLocaleDateString('id-ID', options);
    
    // Ambil Kelas dari API
    const spin = document.getElementById('loadKelas');
    const selKelas = document.getElementById('kelas');
    
    spin.style.display = 'inline-block';
    
    fetch(SCRIPT_URL + '?action=getKelas')
      .then(res => res.json())
      .then(data => {
        data.forEach(k => {
          let opt = document.createElement('option');
          opt.value = k;
          opt.textContent = k;
          selKelas.appendChild(opt);
        });
        spin.style.display = 'none';
      })
      .catch(err => {
        alert("Gagal memuat kelas. Periksa koneksi internet.");
        spin.style.display = 'none';
      });
  };

  // 2. Load Siswa saat Kelas dipilih
  function loadSiswa() {
    const kelas = document.getElementById('kelas').value;
    const elNama = document.getElementById('nama');
    const spin = document.getElementById('loadSiswa');
    
    elNama.innerHTML = '<option value="">Memuat...</option>';
    elNama.disabled = true;
    document.getElementById('nis').value = '';
    
    if(!kelas) {
      elNama.innerHTML = '<option value="">-- Pilih Kelas Dulu --</option>';
      return;
    }

    spin.style.display = 'inline-block';

    fetch(SCRIPT_URL + '?action=getSiswa&kelas=' + encodeURIComponent(kelas))
      .then(res => res.json())
      .then(data => {
        dbSiswa = data;
        elNama.innerHTML = '<option value="">-- Pilih Nama --</option>';
        data.forEach(s => {
          let opt = document.createElement('option');
          opt.value = s.nama;
          opt.textContent = s.nama;
          elNama.appendChild(opt);
        });
        elNama.disabled = false;
        spin.style.display = 'none';
      });
  }

  // 3. Set NIS Otomatis
  function setNIS() {
    const nama = document.getElementById('nama').value;
    const item = dbSiswa.find(s => s.nama === nama);
    if(item) document.getElementById('nis').value = item.nis;
  }

  // 4. Kirim Data (POST)
  function kirimData() {
    const btn = document.getElementById('btnKirim');
    const msg = document.getElementById('msg');
    
    const data = {
      nis: document.getElementById('nis').value,
      nama: document.getElementById('nama').value,
      kelas: document.getElementById('kelas').value,
      status: document.getElementById('status').value,
      keterangan: document.getElementById('ket').value
    };

    if(!data.nis || !data.nama) {
      alert("Mohon lengkapi data Nama dan Kelas!");
      return;
    }

    btn.disabled = true;
    btn.innerText = "Mengirim...";
    msg.style.display = 'none';

    fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(res => {
      btn.disabled = false;
      btn.innerText = "Kirim Absensi";
      msg.style.display = 'block';
      
      if(res.ok) {
        // Cek apakah pesan mengandung kata "TERLAMBAT" dari server
        // (Logika > 06.30 yang dibuat di backend)
        if (res.message.includes("TERLAMBAT") || res.message.includes("Terlambat")) {
            msg.className = 'warning'; // Warna Kuning/Oranye
        } else {
            msg.className = 'success'; // Warna Hijau
        }
        
        msg.innerText = res.message;

        // Reset Form agar siap input lagi
        document.getElementById('nama').value = '';
        document.getElementById('nis').value = '';
        document.getElementById('ket').value = '';
        document.getElementById('status').value = 'Hadir'; // Reset ke default
      } else {
        // Jika Error (misal sudah absen sebelumnya)
        msg.className = 'error';
        msg.innerText = res.message;
      }
    })
    .catch(err => {
      btn.disabled = false;
      btn.innerText = "Kirim Absensi";
      msg.style.display = 'block';
      msg.className = 'error';
      msg.innerText = "Gagal kirim. Cek koneksi internet.";
    });
  }
</script>

</body>
</html>
